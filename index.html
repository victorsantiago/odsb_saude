<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Barcarena — Unidades de Saúde (Conectividade)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <style>
    :root {
      --bg:#ffffff; --panel:#f5f7fb; --text:#0b1020; --muted:#5b6b82;
      --blue:#1e90ff; --red:#ff4d4f; --green:#16a34a; --warn:#f59e0b;
      --rowActive:#fff7ed; --rowHover:#f8fafc;
    }
    html, body { height:100%; margin:0; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial; }
    .app { display:grid; grid-template-rows:auto 1fr; height:100%; }
    header { display:flex; flex-wrap:wrap; gap:16px; align-items:center; padding:12px 16px;
      background:var(--panel); box-shadow:0 2px 12px rgba(0,0,0,.08); position:sticky; top:0; z-index:1000; }
    header h1 { font-size:18px; margin:0; letter-spacing:.2px; }
    .controls { display:flex; flex-wrap:wrap; gap:10px; align-items:center; font-size:14px; color:var(--muted); }
    .badge { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:#eef2f9; }
    .legend-dot { width:10px; height:10px; border-radius:50%; display:inline-block; }
    .legend-dot.blue { background:var(--blue); }
    .legend-dot.red  { background:var(--red); }
    .main { display:grid; grid-template-columns: 1fr 400px; gap:0; height: calc(100vh - 90px); }
    .map { height:100%; }
    aside { border-left: 1px solid #e9eef7; background:#fff; height:100%; overflow:auto; }
    .aside-head { position:sticky; top:0; background:#fff; z-index:5; padding:10px 12px; border-bottom:1px solid #e9eef7; display:flex; gap:8px; align-items:center; }
    .aside-head input[type="search"] { width:100%; padding:10px 12px; border:1px solid #dbe3f0; border-radius:10px; font-size:14px; outline:none; }
    .aside-head input[type="search"]::placeholder { color:#94a3b8; }
    .table-wrap { padding:8px 12px; }
    table { width:100%; border-collapse: collapse; font-size:13px; }
    thead th { position:sticky; top:62px; background:#f8fafc; font-weight:700; text-align:left; padding:8px; border-bottom:1px solid #e9eef7; z-index:4; }
    tbody td { padding:8px; border-bottom:1px solid #f1f5f9; }
    tbody tr:hover { background:var(--rowHover); }
    tbody tr.active { background:var(--rowActive); box-shadow: inset 2px 0 0 var(--warn); }
    td.clickable { cursor:pointer; text-decoration: underline; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; }
    .pill.on { background:#e6f7ef; color:#065f46; }
    .pill.off { background:#fdecea; color:#7f1d1d; }
    .leaflet-popup-content-wrapper { border-radius: 14px; box-shadow: 0 10px 30px rgba(0,0,0,.15); }
    .leaflet-popup-content { margin: 12px 16px; }
    .popup-card h3 { margin: 0 0 10px 0; font-size: 16px; font-weight: 800; }
    .info-table { border-collapse: collapse; width: 100%; }
    .info-table tr:not(:last-child) td { border-bottom: 1px solid #e6edf6; }
    .info-table td { padding: 6px 0; vertical-align: top; }
    .info-table td.k { color: #1f3b63; font-weight: 600; width: 42%; }
    .warn { margin: 10px 16px; padding:10px 12px; background:#fff7ed; border:1px solid #fde68a; border-radius:8px; color:#92400e; display:none; }
    .warn strong { color:#b45309; }
    .warn input { margin-top:8px; }

    /* Botão flutuante para abrir/fechar a lista em telas pequenas */
    .toggle-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--blue);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 52px;
      height: 52px;
      font-size: 24px;
      cursor: pointer;
      display: none;
      box-shadow: 0 4px 12px rgba(0,0,0,.25);
      z-index: 1500;
    }
    .toggle-btn:active { transform: translateY(1px); }

    /* Responsivo: esconde a coluna lateral e mostra o botão */
    @media (max-width: 900px) {
      .main { grid-template-columns: 1fr; }
      aside {
        position: fixed;
        top: 0;
        right: -100%;
        width: 86%;
        max-width: 420px;
        height: 100%;
        transition: right 0.3s ease;
        z-index: 1200;
        box-shadow: -8px 0 24px rgba(0,0,0,.18);
      }
      aside.open { right: 0; }
      .toggle-btn { display: inline-flex; align-items:center; justify-content:center; }
    }
    .title-block {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }

    .title-block h1 {
      margin: 0;
    }

    .title-block .fonte {
      font-size: 12px;
      margin-top: 2px;
      color: #4b5563; /* cinza suave */
    }
    /* KML controls */
    .kml-controls { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .kml-item { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:#eef2f9; }
    .kml-swatch { width:14px; height:14px; border-radius:3px; display:inline-block; box-shadow: inset 0 0 0 1px rgba(0,0,0,.15); }
    .kml-group { display:flex; gap:8px; align-items:center; }
    .kml-sep { width:1px; height:20px; background:#dbe3f0; margin:0 4px; }

  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title-block">
        <h1>Unidades de Saúde (Conectividade)</h1>
        <span class="fonte">Fonte: NIC.br e CONASEMS (Conselho Nacional de Secretarias municipais de Saúde).</span>
        <span class="fonte">Dados de 20/11/2023 (última atualização)</span>
      </div>
      <div class="controls">
        <span class="badge"><span class="legend-dot blue"></span> Com internet</span>
        <span class="badge"><span class="legend-dot red"></span> Sem internet</span>
        <label class="badge"><input id="toggleWith" type="checkbox" checked/> Com Internet</label>
        <label class="badge"><input id="toggleWithout" type="checkbox" checked/> Sem Internet</label>
        <span class="badge"><strong id="countAll">0</strong> unidades</span>
      </div>

    <!-- Controles de Regiões (KML) -->
    <div class="kml-controls" id="kmlControls">
      <div class="kml-group">
        <label class="kml-item"><input type="checkbox" id="kmlAll" checked> <strong>Todos</strong></label>
        <span class="kml-sep"></span>
      </div>
      <div class="kml-group" id="kmlItems"></div>
    </div>
</header>

    <div class="main">
      <div id="map" class="map"></div>
      <aside>
        <div class="aside-head">
          <input id="searchInput" type="search" placeholder="Buscar unidade por nome ou CNES..." />
        </div>
        <div id="warn" class="warn">
          <div><strong>Não foi possível carregar <code>unidades_saude.csv</code></strong>.</div>
          <div>Isso pode acontecer ao abrir o arquivo direto via <code>file://</code>. Você pode:</div>
          <ul>
            <li>Publicar via GitHub Pages/servidor local, <em>ou</em></li>
            <li>Carregar o CSV manualmente abaixo.</li>
          </ul>
        </div>
        <div class="table-wrap">
          <table id="unitsTable">
            <thead>
              <tr>
                <th>Unidade</th>
                <th>Tipo</th>
                <th>Internet</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </aside>
    </div>
  </div>

  <!-- Botão flutuante -->
  <button id="toggleAside" class="toggle-btn" aria-label="Abrir/fechar lista">☰</button>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- FIX: caminho correto do plugin MarkerCluster -->
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script>

  <script>
    // === Mapa ===
    const map = L.map('map').setView([-1.504, -48.625], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const groupWith = L.markerClusterGroup({ disableClusteringAtZoom: 16 });
    const groupWithout = L.markerClusterGroup({ disableClusteringAtZoom: 16 });

    const $countAll = document.getElementById('countAll');
    const $toggleWith = document.getElementById('toggleWith');
    const $toggleWithout = document.getElementById('toggleWithout');
    const $tableBody = document.querySelector('#unitsTable tbody');
    const $warn = document.getElementById('warn');
    const $csvFile = document.getElementById('csvFile');
    const $search = document.getElementById('searchInput');
    const $aside = document.querySelector('aside');
    const $toggleBtn = document.getElementById('toggleAside');

    let DATA = [];
    let latKey = null, lonKey = null;
    const markers = [];
    const markerGroupByIndex = [];
    let filteredIdxs = []; // índices após filtro de busca
    let currentActiveRow = null;

    function healthPin(color) {
      return L.divIcon({
        className: 'custom-pin',
        html: `
          <svg width="28" height="40" viewBox="0 0 28 40" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
                <feDropShadow dx="0" dy="2" stdDeviation="2" flood-color="rgba(0,0,0,0.25)"/>
              </filter>
            </defs>
            <path d="M14 0C6.268 0 0 6.268 0 14c0 9.708 12.12 25.0 12.64 25.64a1.9 1.9 0 0 0 2.72 0C15.88 39 28 23.708 28 14 28 6.268 21.732 0 14 0z"
                  fill="\${color}" filter="url(#shadow)"/>
            <rect x="12" y="6" width="4" height="16" rx="1" fill="white"/>
            <rect x="6" y="12" width="16" height="4" rx="1" fill="white"/>
          </svg>
        `.replace("\${color}", color),
        iconSize: [28, 40],
        iconAnchor: [14, 40],
        popupAnchor: [0, -36]
      });
    }
    const iconBlue = healthPin('#1e90ff');
    const iconRed  = healthPin('#ff4d4f');

    function normalizeBool(v) {
      if (v == null) return null;
      const s = String(v).trim().toLowerCase();
      if (["sim","yes","true","1","y","s","com","tem","possui"].includes(s)) return true;
      if (["nao","não","no","false","0","n","sem"].includes(s)) return false;
      const n = Number(s.replace(',', '.'));
      if (!isNaN(n)) return n > 0;
      return null;
    }
    function parseNumber(v) {
      if (v == null) return NaN;
      const s = String(v).trim().replace(',', '.');
      return Number(s);
    }
    function val(r, keys, fallback="") {
      for (const k of keys) if (r[k] != null && String(r[k]).trim() !== "") return r[k];
      return fallback;
    }

    function buildPopup(r) {
      const nome = val(r, ["Nome Fantasia","Nome","Unidade","NO_FANTASIA","NO_UNIDADE_SAUDE"], "Unidade de Saúde");
      const tipo = val(r, ["Tipo Unidade","Tipo","TP_UNIDADE"], "-");
      const cnes = val(r, ["CNES","cnes","CO_UNIDADE"], "-");
      const gest = val(r, ["Gestão","Gestao","Esfera","TP_GESTAO"], "-");
      const net  = val(r, ["Internet","CE Internet","Conectividade","COM_INTERNET","INTERNET"], "-");
      const hasNet = normalizeBool(net);
      const netOut = hasNet===true ? "Sim" : (hasNet===false ? "Não" : String(net||"-"));
      return `
        <div class="popup-card">
          <h3>${nome}</h3>
          <table class="info-table">
            <tr><td class="k">Tipo</td><td>${tipo}</td></tr>
            <tr><td class="k">CNES</td><td>${cnes}</td></tr>
            <tr><td class="k">Gestão</td><td>${gest}</td></tr>
            <tr><td class="k">Internet</td><td><span class="pill ${hasNet ? 'on' : 'off'}">${netOut}</span></td></tr>
          </table>
        </div>`;
    }

    function detectLatLonKeys() {
      const keys = Object.keys(DATA[0] || {});
      function findKey(cands) {
        for (const k of keys) { const kl = k.toLowerCase(); for (const c of cands) if (kl === c) return k; }
        for (const k of keys) { const kl = k.toLowerCase(); for (const c of cands) if (kl.includes(c)) return k; }
        return null;
      }
      latKey = findKey(["latitude","latitute","lat","coord y","y","coordenaday","nu_latitude"]);
      lonKey = findKey(["longitude","lon","lng","long","coord x","x","coordenadax","nu_longitude"]);
    }

    function updateCount() {
      const withCount = groupWith.getLayers().length;
      const withoutCount = groupWithout.getLayers().length;
      let visible = 0;
      if ($toggleWith.checked)    visible += withCount;
      if ($toggleWithout.checked) visible += withoutCount;
      $countAll.textContent = visible;
    }

    // >>> Atualizado: aplica filtros também na tabela
    function refreshVisibility() {
      if ($toggleWith.checked) map.addLayer(groupWith); else map.removeLayer(groupWith);
      if ($toggleWithout.checked) map.addLayer(groupWithout); else map.removeLayer(groupWithout);
      updateCount();

      // Calcula quais índices ficam visíveis considerando busca + toggles
      const visibleIdxs = filteredIdxs.filter(idx => {
        const r = DATA[idx];
        const hasNet = normalizeBool(val(r, ["Internet","CE Internet","Conectividade","COM_INTERNET","INTERNET"], null));
        if (hasNet === true && !$toggleWith.checked) return false;
        if (hasNet === false && !$toggleWithout.checked) return false;
        return true;
      });
      renderTable(visibleIdxs);
    }

    function clearActiveRow() {
      if (currentActiveRow && currentActiveRow.isConnected) {
        currentActiveRow.classList.remove('active');
      }
      currentActiveRow = null;
    }

    function setActiveRowByIndex(idx) {
      clearActiveRow();
      const row = document.querySelector(`tr[data-idx="${idx}"]`);
      if (row) {
        row.classList.add('active');
        currentActiveRow = row;
        row.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
      }
    }

    function flyAndOpen(marker, belongsTo, idxForRowHighlight=null) {
      if (belongsTo === 'with' && !$toggleWith.checked) { $toggleWith.checked = true; }
      if (belongsTo === 'without' && !$toggleWithout.checked) { $toggleWithout.checked = true; }
      refreshVisibility();
      const latlng = marker.getLatLng();
      map.flyTo(latlng, Math.max(map.getZoom(), 16), { duration: 0.6 });
      setTimeout(() => { marker.openPopup(); }, 600);
      if (idxForRowHighlight != null) setActiveRowByIndex(idxForRowHighlight);
      if (window.matchMedia('(max-width: 900px)').matches) $aside.classList.remove('open');
    }

    function renderTable(indexes) {
      $tableBody.innerHTML = "";
      indexes.forEach((idx) => {
        const r = DATA[idx];
        const hasNet = normalizeBool(val(r, ["Internet","CE Internet","Conectividade","COM_INTERNET","INTERNET"], null));
        const nome = val(r, ["Nome Fantasia","Nome","Unidade","NO_FANTASIA","NO_UNIDADE_SAUDE"], "Unidade de Saúde");
        const tipo = val(r, ["Tipo Unidade","Tipo","TP_UNIDADE"], "-");
        const netOut = hasNet===true ? "Sim" : (hasNet===false ? "Não" : String(val(r, ["Internet","CE Internet","Conectividade","COM_INTERNET","INTERNET"], "-")));
        const pillClass = hasNet ? "pill on" : (hasNet===false ? "pill off" : "pill");

        const tr = document.createElement("tr");
        tr.setAttribute('data-idx', String(idx));
        tr.innerHTML = `
          <td class="clickable">${nome}</td>
          <td class="clickable">${tipo}</td>
          <td class="clickable"><span class="${pillClass}">${netOut}</span></td>
        `;
        tr.addEventListener('click', () => {
          flyAndOpen(markers[idx], markerGroupByIndex[idx], idx);
        });
        $tableBody.appendChild(tr);
      });
    }

    function applySearch() {
      const q = ($search.value || "").toLowerCase().trim();
      if (!q) {
        filteredIdxs = DATA.map((_, i) => i);
      } else {
        filteredIdxs = DATA.map((r, i) => {
          const nome = val(r, ["Nome Fantasia","Nome","Unidade","NO_FANTASIA","NO_UNIDADE_SAUDE"], "");
          const cnes = val(r, ["CNES","cnes","CO_UNIDADE"], "");
          return { i, hay: (nome + " " + cnes).toLowerCase() };
        }).filter(obj => obj.hay.includes(q)).map(obj => obj.i);
      }
      // >>> Atualizado: após busca, respeitar toggles
      refreshVisibility();
    }

    function refreshMapAndBuild() {
      groupWith.clearLayers();
      groupWithout.clearLayers();
      markers.length = 0;
      markerGroupByIndex.length = 0;

      DATA.forEach((r, idx) => {
        const lat = parseNumber(latKey ? r[latKey] : r["Latitude"]);
        const lon = parseNumber(lonKey ? r[lonKey] : r["Longitude"]);
        if (!Number.isFinite(lat) || !Number.isFinite(lon)) return;
        const hasNet = normalizeBool(val(r, ["Internet","CE Internet","Conectividade","COM_INTERNET","INTERNET"], null));
        const marker = L.marker([lat, lon], { icon: hasNet === false ? iconRed : iconBlue })
                        .bindPopup(buildPopup(r));

        marker.on('popupopen', () => setActiveRowByIndex(idx));
        marker.on('popupclose', () => {
          const row = document.querySelector(`tr[data-idx="${idx}"]`);
          if (row && row === currentActiveRow) clearActiveRow();
        });

        const group = (hasNet === false ? groupWithout : groupWith);
        group.addLayer(marker);

        markers[idx] = marker;
        markerGroupByIndex[idx] = (hasNet === false ? 'without' : 'with');
      });

      const bounds = L.featureGroup([groupWith, groupWithout]).getBounds();
      if (bounds.isValid()) map.fitBounds(bounds.pad(0.1));
      updateCount();

      filteredIdxs = DATA.map((_, i) => i);
      // >>> Atualizado: render respeitando os toggles
      refreshVisibility();
    }

    // === Carregamento do CSV ===
    const DATA_URL = 'unidades_saude.csv';
    async function loadCSV() {
      try {
        const res = await fetch(DATA_URL, { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const text = await res.text();
        const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
        DATA = parsed.data;
        detectLatLonKeys();
        refreshMapAndBuild();
      } catch (e) {
        console.error('Falha ao carregar CSV via fetch:', e);
        $warn.style.display = 'block';
      }
    }
    loadCSV();

    // Busca com debounce leve
    let searchTimer = null;
    $search.addEventListener('input', () => {
      if (searchTimer) cancelAnimationFrame(searchTimer);
      searchTimer = requestAnimationFrame(applySearch);
    });

    // Eventos dos toggles
    $toggleWith.addEventListener('change', refreshVisibility);
    $toggleWithout.addEventListener('change', refreshVisibility);

    // Botão flutuante: abrir/fechar a lista lateral em telas pequenas
    $toggleBtn.addEventListener('click', () => {
      $aside.classList.toggle('open');
    });

    // Fecha a lista ao clicar no mapa em telas pequenas
    map.on('click', () => {
      if (window.matchMedia('(max-width: 900px)').matches) {
        $aside.classList.remove('open');
      }
    });

// ====== KMLs (Regiões) ======
const KMLS = [
      { id: 'barcarena',    name: 'Barcarena',          file: 'kml/barcarena_dissolved_lines.kml',  color: '#7c3aed' },
      { id: 'estradas',     name: 'Estradas',           file: 'kml/estradas_dissolved_lines.kml',   color: '#2563eb' },
      { id: 'ilhas',        name: 'Ilhas',              file: 'kml/ilhas_dissolved_lines.kml',      color: '#10b981' },
      { id: 'murucupi',     name: 'Murucupi',           file: 'kml/murucupi_dissolved_lines.kml',   color: '#f59e0b' },
      { id: 'viladoconde',  name: 'Vila do Conde',      file: 'kml/viladoconde_dissolved_lines.kml',color: '#ef4444' },
    ];

const kmlLayers = new Map(); // id -> layer
const kmlBounds = L.featureGroup();
function styleFor(color) { return { color, weight: 3, opacity: 0.9 }; }

function addKmlToMap(k) {
  if (kmlLayers.has(k.id)) { // já carregado?
    const layer = kmlLayers.get(k.id);
    if (!map.hasLayer(layer)) layer.addTo(map);
    return;
  }
  const layer = omnivore.kml(k.file, null, L.geoJSON(null, { style: styleFor(k.color) }));
  layer.on('ready', () => {
    kmlBounds.addLayer(layer);
    // No primeiro load de todos, ajusta o fit
    if (!map._kmlFitDone) {
      const b = kmlBounds.getBounds();
      if (b.isValid()) map.fitBounds(b.pad(0.08));
      map._kmlFitDone = true;
    }
  });
  layer.addTo(map);
  kmlLayers.set(k.id, layer);
}

function removeKmlFromMap(id) {
  const layer = kmlLayers.get(id);
  if (layer) {
    map.removeLayer(layer);
    kmlBounds.removeLayer(layer);
  }
}

// UI
const $kmlItems = document.getElementById('kmlItems');
const $kmlAll = document.getElementById('kmlAll');

function renderKmlUI() {
  $kmlItems.innerHTML = '';
  KMLS.forEach(k => {
    const lbl = document.createElement('label');
    lbl.className = 'kml-item';
    lbl.innerHTML = `<span class="kml-swatch" style="background:${k.color}"></span>
                     <input type="checkbox" data-kml="${k.id}" checked> ${k.name}`;
    $kmlItems.appendChild(lbl);
  });
}

function bindKmlEvents() {
  // Toggle individual
  $kmlItems.querySelectorAll('input[type="checkbox"][data-kml]').forEach(chk => {
    chk.addEventListener('change', (e) => {
      const id = e.target.getAttribute('data-kml');
      const k = KMLS.find(x => x.id === id);
      if (!k) return;
      if (e.target.checked) addKmlToMap(k);
      else removeKmlFromMap(id);

      // Atualiza o master "Todos"
      const allInputs = Array.from($kmlItems.querySelectorAll('input[type="checkbox"][data-kml]'));
      $kmlAll.checked = allInputs.every(i => i.checked);
    });
  });

  // Master toggle "Todos"
  $kmlAll.addEventListener('change', (e) => {
    const checked = e.target.checked;
    $kmlItems.querySelectorAll('input[type="checkbox"][data-kml]').forEach(i => {
      const id = i.getAttribute('data-kml');
      i.checked = checked;
      const k = KMLS.find(x => x.id === id);
      if (checked) addKmlToMap(k);
      else removeKmlFromMap(id);
    });
  });
}

function initKmls() {
  renderKmlUI();
  bindKmlEvents();
  // Carrega todos inicialmente (opção "Todos" marcada por padrão)
  KMLS.forEach(addKmlToMap);
  $kmlAll.checked = true;
}

// Inicializa KMLs quando a página estiver pronta
if (document.readyState !== 'loading') initKmls();
else document.addEventListener('DOMContentLoaded', initKmls);

  </script>
</body>
</html>
